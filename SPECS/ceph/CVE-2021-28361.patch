From f3fd56fc3c73ee7595bbe7c69cf8048fe2577e1a Mon Sep 17 00:00:00 2001
From: Tomasz Zawadzki <tomasz.zawadzki@intel.com>
Date: Mon, 8 Feb 2021 10:28:44 -0500
Subject: [PATCH] lib/iscsi: return immediately from iscsi_parse_params if len
 is 0

The spec does not disallow TEXT PDUs with no data.  In that
case, just return immediately from iscsi_parse_params.

This avoids a NULL pointer dereference with a TEXT PDU that has
no data, but CONTINUE flag is set.

Signed-off-by: Tomasz Zawadzki <tomasz.zawadzki@intel.com>
Signed-off-by: Jim Harris <james.r.harris@intel.com>
Change-Id: I2605293daf171633a45132d7b5532fdfc9128aff
Reviewed-on: https://review.spdk.io/gerrit/c/spdk/spdk/+/6319
Tested-by: SPDK CI Jenkins <sys_sgci@intel.com>
Reviewed-by: Ziye Yang <ziye.yang@intel.com>
Reviewed-by: Shuhei Matsumoto <shuhei.matsumoto.xt@hitachi.com>
Reviewed-by: Ben Walker <benjamin.walker@intel.com>
Reviewed-by: Paul Luse <paul.e.luse@intel.com>
Signed-off-by: Henry Beberman <henry.beberman@microsoft.com>
diff -Naur a/src/spdk/lib/iscsi/param.c b/src/spdk/lib/iscsi/param.c
--- a/src/spdk/lib/iscsi/param.c	2020-07-31 07:07:10.000000000 +0000
+++ b/src/spdk/lib/iscsi/param.c	2024-05-09 17:34:00.036617778 +0000
@@ -315,6 +315,16 @@
 	char *p;
 	int i;
 
+	/* Spec does not disallow TEXT PDUs with zero length, just return
+	 * immediately in that case, since there is no param data to parse
+	 * and any existing partial parameter would remain as-is.
+	 */
+	if (len == 0) {
+		return 0;
+	}
+
+	assert(data != NULL);
+
 	/* strip the partial text parameters if previous PDU have C enabled */
 	if (partial_parameter && *partial_parameter) {
 		for (i = 0; i < len && data[i] != '\0'; i++) {
