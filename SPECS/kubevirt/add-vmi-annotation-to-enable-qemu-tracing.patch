From a69036768ee766ee55391e9f59637b7878c28b0b Mon Sep 17 00:00:00 2001
From: Brian Fjeldstad <bfjelds@microsoft.com>
Date: Wed, 8 May 2024 20:19:45 +0000
Subject: [PATCH] add vmi annotation to enable qemu tracing

---
 pkg/virt-launcher/virtwrap/converter/converter.go | 11 +++++++++++
 staging/src/kubevirt.io/api/core/v1/types.go      |  3 +++
 2 files changed, 14 insertions(+)

diff --git a/pkg/virt-launcher/virtwrap/converter/converter.go b/pkg/virt-launcher/virtwrap/converter/converter.go
index 2b7a7a0fd..705304358 100644
--- a/pkg/virt-launcher/virtwrap/converter/converter.go
+++ b/pkg/virt-launcher/virtwrap/converter/converter.go
@@ -1781,6 +1781,17 @@ func Convert_v1_VirtualMachineInstance_To_api_Domain(vmi *v1.VirtualMachineInsta
 	domain.Spec.Devices.Interfaces = append(domain.Spec.Devices.Interfaces, domainInterfaces...)
 	domain.Spec.Devices.HostDevices = append(domain.Spec.Devices.HostDevices, c.SRIOVDevices...)
 
+	// Add Trace command line if VMI is annotated
+	traceeventsdata, _ := vmi.Annotations[v1.TraceEventsAnnotation]
+	if traceeventsdata != "" {
+		initializeQEMUCmdAndQEMUArg(domain)
+		traceevents := strings.Split(traceeventsdata, " ")
+		for _, traceevent := range traceevents {
+			domain.Spec.QEMUCmd.QEMUArg = append(domain.Spec.QEMUCmd.QEMUArg, api.Arg{Value: "-trace"})
+			domain.Spec.QEMUCmd.QEMUArg = append(domain.Spec.QEMUCmd.QEMUArg, api.Arg{Value: traceevent})
+		}
+	}
+
 	// Add Ignition Command Line if present
 	ignitiondata, _ := vmi.Annotations[v1.IgnitionAnnotation]
 	if ignitiondata != "" && strings.Contains(ignitiondata, "ignition") {
diff --git a/staging/src/kubevirt.io/api/core/v1/types.go b/staging/src/kubevirt.io/api/core/v1/types.go
index 1ac4fefaf..6ea9d540e 100644
--- a/staging/src/kubevirt.io/api/core/v1/types.go
+++ b/staging/src/kubevirt.io/api/core/v1/types.go
@@ -821,6 +821,9 @@ const (
 	// Used on VirtualMachineInstance.
 	IgnitionAnnotation           string = "kubevirt.io/ignitiondata"
 	PlacePCIDevicesOnRootComplex string = "kubevirt.io/placePCIDevicesOnRootComplex"
+	// This annotation is used to inject tracing
+	// Used on VirtualMachineInstance.
+	TraceEventsAnnotation        string = "kubevirt.io/trace-events"
 
 	// This label represents supported cpu features on the node
 	CPUFeatureLabel = "cpu-feature.node.kubevirt.io/"
-- 
2.34.1

